{% extends 'base.html' %}
{% load bootstrap3 %}
{% load i18n %}
{% load static %}

{% block title %} IRMA System - {% trans "Welcome " %} {% endblock %}

{% block upper_main %}
<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
  </ol>

  <!-- Wrapper for slides -->
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="{% static 'img/image1.jpg' %}">
    </div>

    <div class="item">
      <img src="{% static 'img/image2.jpg' %}">
    </div>

    <div class="item">
      <img src="{% static 'img/image3.jpg' %}">
    </div>

    <div class="item">
      <img src="{% static 'img/image4.jpg' %}">
    </div>
  </div>

  <!-- Left and right controls -->
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
    <span class="sr-only">{% trans "Previous" %}</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
    <span class="sr-only">{% trans "Next" %}</span>
  </a>
</div>

{% endblock %}
{% block main_page %}
<div class="row">
  <div class="col-md-12">
    <div class="panel panel-default">
    <div class="panel-heading">
  &nbsp;
    <div class="row">
      <div class="col-md-4">
        <h4>&nbsp;&nbsp;&nbsp;{% trans "View historical available data" %}<br>
            &nbsp;&nbsp;&nbsp;<sub>{% trans "Time Period" %}: <span class="text-success">{{ start_date|date:"Y-m-d" }}</span> : <span class="text-success">{{ end_date|date:"Y-m-d" }}</span></sub>
        </h4>
      </div>
      <div class="col-md-6">
        <div class="form-group">
          <select onchange="create_map(document.getElementById('mirror_field').value,document.getElementById('meteo_var').value )" id="meteo_var" class="form-control">
            <option value="Daily_rain_">{% trans "Daily Rainfall" %} (mm/d)</option>
            <option value="Daily_evaporation_">{% trans "Daily Potential Evapotranspiration" %} (mm/d)</option>
            <option value="Daily_humidity_">{% trans "Daily Humidity" %} (%)</option>
            <option value="Daily_temperature_">{% trans "Daily Temperature" %} (°C)</option>
            <option value="Daily_wind_speed_">{% trans "Daily Wind Speed" %} (m/s)</option>
            <option value="Daily_solar_radiation_">{% trans "Daily Solar Radiation" %} (W/m²)</option>
          </select>
        <div onchange="create_map(document.getElementById('mirror_field').value,document.getElementById('meteo_var').value )" style="float: left;" class="form-group">
          <div class='input-group date' id='form_datetime'>
            <input type='text' class="form-control" />
            <input type="hidden" class="form-control" id="mirror_field" value="2015-04-06" readonly />
            <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
       <div class="panel-body">
          <div id="wms_map" class="map"></div>
          <div><h4 id="date_map"></h4></div>
            <button id="previous" type="button" class="btn btn-default" onclick="previous_map()"><i class="fa fa-chevron-left"></i>&nbsp;</button>
            <button id="current" class="btn btn-default"></button>
            <button id="next" type="button" class="btn btn-default" onclick="next_map()"><i class="fa fa-chevron-right"></i>&nbsp;</button>
            <a style="float: right;" class="btn btn-success btn-xs" target="_blank" href="http://system.irrigation-management.eu/"> {% trans "View Meteorogical Network Stations" %}</a> <br>
            <a style="float: right;" class="btn btn-success btn-xs" href="{% url 'maps' %}"> {% trans "Maps from satellite images" %}</a>
       </div>
    </div>
  </div>
</div>
      <script type="text/javascript">
          $("#form_datetime").datetimepicker({
            format: "yyyy-mm-dd",
            startDate: "2015-01-01",
            initialDate: '{{ yesterday|date:"Y-m-d" }}',
            endDate:'{{ yesterday|date:"Y-m-d" }}',
            autoclose: true,
            pickerPosition: "bottom-left",
            minView:2,
            startView:2,
            todayHighlight:false,
            linkField: "mirror_field",
            linkFormat: "yyyy-mm-dd",
            pickerPosition: "bottom-left"
            });

          function create_map(date, meteo_var)
            {
              date = (date === undefined) ? '{{ yesterday|date:"Y-m-d" }}' : date;
              meteo_var = (meteo_var === undefined) ? 'Daily_rain_' : meteo_var;
              // Clear previous map
              document.getElementById('wms_map').innerHTML = ""
              // Map object
              map = new OpenLayers.Map('wms_map',
                    {units: 'm',
                     displayProjection: 'EPSG:4326',
                     controls: [new OpenLayers.Control.LayerSwitcher(),
                                new OpenLayers.Control.Navigation(),
                                new OpenLayers.Control.Zoom(),
                                new OpenLayers.Control.MousePosition(),
                                new OpenLayers.Control.ScaleLine()]
                     });
              //Base layer
              var base_cycle = new OpenLayers.Layer.OSM.CycleMap(
                        "Open Cycle Map",
                        {isBaseLayer: true,
                         projection: 'EPSG:3857'});
              map.addLayer(base_cycle);
              // Loop to add WMS layers
              var ktimatologio = new OpenLayers.Layer.WMS("Hellenic Cadastre",
                         "http://gis.ktimanet.gr/wms/wmsopen/wmsserver.aspx",
                           {   layers: 'KTBASEMAP', transparent: false},
                           {   isBaseLayer: true,
                               projection: new OpenLayers.Projection("EPSG:900913"),
                               iformat: 'image/png'});
              map.addLayer(ktimatologio);
              var map_variable = new OpenLayers.Layer.WMS(
                        meteo_var + date,
                        "http://megdobas.irrigation-management.eu/cgi-bin/mapserver?map=/var/cache/pthelma/mapserver-historical.map",
                        {layers: meteo_var + date,
                         format: 'image/png'},
                        {isBaseLayer: false,
                         projection: 'EPSG:3857',
                         opacity: 0.65});
              map.addLayer(map_variable);
              document.getElementById('current').innerHTML = '{% trans "Viewing:" %}' + date;
              document.getElementById('next').value = moment(date, "YYYY-MM-DD").add(1,'days').format("YYYY-MM-DD");
              var n = moment(document.getElementById('next').value, "YYYY-MM-DD");
              if (n.isAfter('{{ yesterday|date:"Y-m-d" }}')) {
                  document.getElementById('next').style.display ='none';
              } else {
                  document.getElementById('next').style.display = 'inline-block';
                  document.getElementById('next').innerHTML = moment(date, "YYYY-MM-DD").add(1,'days').format("YYYY-MM-DD") + "&nbsp;<i class='fa fa-chevron-right'></i>&nbsp;";
              }

              document.getElementById('previous').value = moment(date, "YYYY-MM-DD").subtract(1,'days').format("YYYY-MM-DD");
              var pr = moment(document.getElementById('previous').value, "YYYY-MM-DD");
              if (pr.isBefore('2015-01-01')) {
                  document.getElementById('previous').style.display ='none';
              } else {
                  document.getElementById('previous').style.display ='inline-block';
                  document.getElementById('previous').innerHTML = "&nbsp;<i class='fa fa-chevron-left'></i>&nbsp;" + moment(date, "YYYY-MM-DD").subtract(1,'days').format("YYYY-MM-DD");


              }

              // When clicking on the map, show popup with values of variables
              OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {
                  defaultHandlerOptions: {
                      'single': true,
                      'double': false,
                      'pixelTolerance': 0,
                      'stopSingle': false,
                      'stopDouble': false
                  },
                  initialize: function(options) {
                      this.handlerOptions = OpenLayers.Util.extend(
                          {}, this.defaultHandlerOptions
                      );
                      OpenLayers.Control.prototype.initialize.apply(
                          this, arguments
                      );
                      this.handler = new OpenLayers.Handler.Click(
                          this, {
                              'click': this.trigger
                          }, this.handlerOptions
                      );
                  },
                  trigger: function(e) {
                      var lonlat = map.getLonLatFromPixel(e.xy);
                      var xhr = new XMLHttpRequest();

                      // Create a small bbox such as the point is at the bottom left of the box
                      var xlow = lonlat.lon;
                      var xhigh = lonlat.lon + 50;
                      var ylow = lonlat.lat;
                      var yhigh = lonlat.lat + 50;
                      var bbox = xlow + ',' + ylow + ',' + xhigh + ',' + yhigh

                      // Determine layers
                      var layers='';
                      ['temperature', 'humidity', 'wind_speed', 'rain', 'evaporation'].forEach(function(s) {
                          if (layers != '') {
                              layers = layers + ',';
                          }
                          layers = layers + 'Daily_' + s + '_' + date;
                      })

                      // Assemble URL
                      var url = 'http://arta.irrigation-management.eu/mapserver-historical/';
                      url = url + '?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&SRS=EPSG:3857&info_format=text/html';
                      url = url + '&BBOX=' + bbox + '&WIDTH=2&HEIGHT=2&X=0&Y=0';
                      url = url + '&LAYERS=' + layers + '&QUERY_LAYERS=' + layers;

                      xhr.open('GET', url, false);
                      xhr.send()
                      if (xhr.readyState == 4) {
                          map.addPopup(new OpenLayers.Popup.FramedCloud(
                                       null, lonlat, null,
                                       xhr.responseText,
                                       null, true));
                      }
                  }
              });
              var click = new OpenLayers.Control.Click();
              map.addControl(click);
              click.activate();

              // Add controll and center
              map.setCenter (new OpenLayers.LonLat(20.98, 39.15).transform('EPSG:4326', 'EPSG:3857'), 10);
           }

           function previous_map() {
            var swap_date = document.getElementById('previous').value
            var meteo_var = document.getElementById('meteo_var').value
            create_map(swap_date, meteo_var);
           }

           function next_map() {
            var swap_date = document.getElementById('next').value
            var meteo_var = document.getElementById('meteo_var').value
            create_map(swap_date, meteo_var);
           }

           function current() {
            var swap_date = document.getElementById('current').value
            var meteo_var = document.getElementById('meteo_var').value
            create_map(swap_date, meteo_var);
           }
           // Initial map in first request
           create_map();
      </script>
{% endblock %}
